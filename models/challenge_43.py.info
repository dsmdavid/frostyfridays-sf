# The Snowpark package is required for Python Worksheets. 
# You can add more packages by selecting them using the Packages control and then importing them.

import snowflake.snowpark as snowpark
import json
import pandas
from snowflake.snowpark.functions import col

def main(session: snowpark.Session): 
    tableName = 'challenge_43_01'
    dataframe = session.table(tableName)
    df = dataframe.to_pandas()
    # parse json
    df['json'] = df['JSON'].apply(lambda x: json.loads(x))
    # extract the superheroes
    tmp_df = pandas.json_normalize(df.iloc[0]['json'],
                                   record_path = ['superheroes'],
                                   meta=['company_name', 'company_website','location'])
    # expand the location
    end = pandas.concat([
        tmp_df,
        tmp_df['location'].apply(pandas.Series)
        ], axis=1)\
    .drop('location', axis=1)
    
    # Return with the requested order
    return session.create_dataframe(end[['id','company_name','company_website',
                                         'address','city','country','state',
                                         'zip','name','powers','real_name',
                                         'role','years_of_experience']]
                                   )